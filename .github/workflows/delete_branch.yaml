name: Cleanup Branch from test-branch and test-branch1

on:
  workflow_dispatch:
    inputs:
      BRANCH_TO_DELETE:
        description: 'Branch name to delete (must not be main/dev)'
        required: true

env:
  REPOS: |
    muhammad-anzar/test-branch
    muhammad-anzar/test-branch1

jobs:
  delete-branch:
    runs-on: ubuntu-latest

    steps:
      - name: Prepare Git Metadata
        run: |
          echo "USER=${{ github.actor }}" >> $GITHUB_ENV
          echo "EMAIL=$(git log -1 --pretty=format:'%ae')" >> $GITHUB_ENV
      - name: Validate input branch
        run: |
          BRANCH="${{ github.event.inputs.BRANCH_TO_DELETE }}"
          if [[ "$BRANCH" == "main" || "$BRANCH" == "dev" ]]; then
            echo "❌ Refusing to delete protected branch: $BRANCH"
            exit 1
          fi

      - name: Delete branch from repositories if it exists
        env:
          BRANCH: ${{ github.event.inputs.BRANCH_TO_DELETE }}
          TOKEN: ${{ secrets.PAT }}
        run: |
          for REPO in $REPOS; do
            echo "Processing repository: $REPO"
      
            # Check if branch exists
            if git ls-remote --exit-code --heads https://x-access-token:$TOKEN@github.com/$REPO.git "$BRANCH" > /dev/null; then
              echo "Branch '$BRANCH' exists. Deleting branch..."
              git init --quiet
              git config user.name "$USER"
              git config user.email "$EMAIL"
              git remote add origin https://x-access-token:$TOKEN@github.com/$REPO.git
              # Delete branch remotely
              git push origin --delete "$BRANCH"
              echo "Deleted branch '$BRANCH' from $REPO"
              git fetch origin main --depth=1
              git checkout main
              # Remove configuration folder for the branch
              CONFIG_PATH="configurations/$BRANCH"
              if [ -d "$CONFIG_PATH" ]; then
                git rm -r "$CONFIG_PATH"
                git commit -m "Remove configuration for deleted branch $BRANCH" || echo "Nothing to commit"
                git push origin main
                echo "Deleted configuration folder '$CONFIG_PATH' from dev branch"
              else
                echo "Configuration folder '$CONFIG_PATH' not found in dev branch. Skipping."
              fi
      
              rm -rf .git
            else
              echo "Branch '$BRANCH' does not exist in $REPO. Skipping."
            fi
          done
